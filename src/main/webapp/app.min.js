angular.module("gp",["templates","ui.ace","ngDialog","LocalStorageModule"]).config(["localStorageServiceProvider",function(e){e.setPrefix("groovyplayground")}]),angular.module("gp").controller("EditorController",["$scope","$http","$q","$location","gists","ngDialog","localStorageService",function(e,t,n,o,i,r,a){var u,c,l="source",s=ace.require("ace/range").Range,g=[],f=function(e,t){r.open({template:"views/errorDialog.html",data:{error:e,data:t},className:"ngdialog-theme-default error-dialog"})},d=function(t){0===Object.keys(t.files).length?f("no_files"):(e.source="",angular.forEach(t.files,function(n){t.files.length>1&&(e.source+="// "+n.filename+"\n"),e.source+=n.content,e.source+="\n\n"}),o.search("load",t.id))},h=function(e){404===e.status?f("not_found"):403===e.status?f("limit_exceeded",{reset:1e3*e.headers("X-RateLimit-Reset")}):f("generic")},p=function(e){i.byId(e).then(d,h)};e.source=a.get(l)||"";var m=o.search();angular.isString(m.load)&&m.load.length>0&&p(m.load);var v=n.defer(),w=function(){return v.promise};e.evaluate=function(){o.search("load",null),a.set(l,e.source),e.result={},e.output=[],e.error=null,e.isLoading=!0,u&&u.resolve();var i=n.defer();u=i,t.post("/api/script",{source:e.source},{timeout:u.promise}).then(function(t){e.result=t.data;var n=[[]],o=0;angular.forEach(e.result.output,function(e){n[o].push(e),e.lineBreak&&(n.push([]),o++)}),0===n[n.length-1].length&&n.splice(-1),e.error=null,e.output=n,e.interactiveOutput=!0})["catch"](function(t){418===t.status?(e.interactiveOutput=!1,e.error="DEADLINE_EXCEEDED"):e.error="UNKNOWN"})["finally"](function(){i===u&&(u=null,e.isLoading=!1)})},e.aceLoaded=function(e){v.resolve(e),e.focus()},e.gistLoadDialog=function(){r.open({template:"views/gistLoad.html",className:"ngdialog-theme-default wide-dialog"}).closePromise.then(function(e){e.value&&"$"!=e.value[0]&&p(e.value)})},e.highlightLine=function(t){e.interactiveOutput&&w().then(function(e){g.forEach(function(t){e.getSession().removeMarker(t)}),t>=0&&g.push(e.getSession().addMarker(new s(t,0,t,1),"output-cause-line","fullLine"))})},e.createGist=function(){e.gistCreating=!0,t.post("https://api.github.com/gists",{description:"","public":!1,files:{"script.groovy":{content:e.source}}}).then(function(e){r.open({template:"views/gistcreated.html",data:{url:e.data.html_url},className:"ngdialog-theme-default gist-dialog"})})["catch"](h)["finally"](function(){e.gistCreating=!1})},e.clear=function(){e.source=""},e.showInfo=function(){r.open({template:"views/info.html",className:"ngdialog-theme-default wide-dialog info-dialog"})},e.$watch("interactiveOutput",function(t,n){t&&!n&&(c=e.$watch("source",function(t,n){t!==n&&(w().then(function(e){e.getSession().clearAnnotations()}),e.interactiveOutput=!1,c())}))}),e.$watch("result",function(e){if(e&&e.output){var t=e.output.filter(function(e){return"EXCEPTION"===e.type||"COMPILATION_ERROR"===e.type});w().then(function(e){e.getSession().setAnnotations(t.map(function(e){return{row:e.line-1,text:e.message,type:"error"}}))})}})}]),angular.module("gp").directive("clickHotkey",["$document",function(e){return{restrict:"A",link:function(t,n){function o(e){return e.ctrlKey&&(13===e.which||10===e.which)}e.bind("keypress",function(e){o(e)&&angular.element(n).triggerHandler("click")})}}}]),angular.module("gp").service("gists",["$http",function(e){function t(t){return e.get(n+"/"+t).then(function(e){return e.data})}var n="https://api.github.com/gists";return{byId:t}}]);